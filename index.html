<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta name=viewport content="width=device-width, initial-scale=1">

    <title>Cyclotron Viewer</title>

    <style>
    body, html {
        font-family: sans-serif;
    }

    #display {
        object-fit: cover;
        height: 100vh;
        width: 100vw;
        z-index: -1;
    }

    #entertainThePeasants {
        padding: 20px;
    }

    #video {display: none;}

    footer {
        position: fixed;
        right: 0px;
        bottom: 0px;
        padding-top: 3vh;
        padding-bottom: 3vh;
        padding-left: 3vw;
        padding-right: 3vw;
        z-index: 1;
    }

    #viewer {
        display: none;
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
    }

    #cameraToggleForChrome {
        display: none;
        position: absolute;
        cursor: pointer;
    }

    #takePhotoButton {
        display: block;
        cursor: pointer;
        border: 0;
        background: transparent;
        padding: 0;
    }

    #takePhotoButton img {
        height: 100%;
        width: 100%;
    }

    #recordVideoButton {
        display: none;
        cursor: pointer;
    }
        
    @media (orientation: portrait) {
        footer {
            height: 12vh;
            width: 94vw;
        }

        #cameraToggleForChrome {
            margin: 2vh;
            height: 8vh;
        }

        #takePhotoButton {
            margin-left: auto;
            margin-right: auto;
            height: 12vh;
            width: 12vh;
        }
        #recordVideoButton {
            height: 100%;
        }

    }

    @media (orientation: landscape) {
        footer {
            height: 94vh;
            width: 12vw;
        }

        #cameraToggleForChrome {
            width: 8vw;
            bottom: 0;
            margin: 2vh;
        }

        #takePhotoButton {
            height: 12vw;
            width: 12vw;
            position: absolute;
            bottom: 50vh;
            margin-bottom: -6vw;
        }
    }

    button:focus {
        outline: none;
    }

    </style>
</head>
<body>
    <div id="entertainThePeasants">
        <h1>Cyclotron Viewer</h1>
        <h2>See Light Painting in Real Time Through Augmented Reality</h2>
        <p>
            Go on, lend us your camera! Click that <em>Allow</em> button. We promise not to peek at you. Much.
        </p>
        <p>
            Didn't see anything pop up asking for camera access? That's awkward&#8230; Maybe this browser can't Cyclotron?
        </p>
        <p>
            If you're on Android, then try an up-to-date version of <a target="_blank" href="https://www.getfirefox.com/">Firefox</a> or <a target="_blank" href="https://www.google.com/chrome/">Chrome</a>.
        </p>
        <p>
            If you're on an iPhone, then unfortunately you're out of luck. Some day Apple might update Safari to have the goodies we need, but until then you'll have to go borrow someone with Android, or use a laptop with Firefox or Chrome.
        </p>
    </div>
    <video id="video" autoplay></video>
    <div id="viewer">
        <canvas id="display"></canvas>
        <footer id="controlFooter">
            <img src="img/switch-camera.png" id="cameraToggleForChrome">
            <!-- <button id="recordVideoButton">Record Video</button> -->
            <button id="takePhotoButton">
                <img src="img/shutter-button.png" />
            </button>
        </footer>
    </div>

<script type="text/javascript" src="js/adapter.js"></script>
<!-- <script src="https://cdn.WebRTC-Experiment.com/RecordRTC.js"></script> -->
<!-- <script type="text/javascript" src="https://cdn.webrtc-experiment.com/gif-recorder.js"></script> -->
<script type="text/javascript">
    if (webrtcDetectedBrowser != 'chrome') {
        var constraints = {audio: false, video: { facingMode: 'environment' }};
        attachStream(constraints);
    } else {
        var chromeVideoDeviceInfos;
        var chromeVideoDeviceIndex = 0;
        getSourcesForChrome();
    }

    function attachStream(constraints) {
        if (window.stream) {
            // Required for Chrome
            window.stream.getTracks().forEach(track => track.stop());
        }
        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            window.stream = stream;
            video.srcObject = stream;
            document.getElementById('entertainThePeasants').style.display = 'none'
            document.getElementById('viewer').style.display = 'block'
        })
        .catch(err => console.error(err));
    }

    var canvas = document.getElementById('display'),
        ctx = canvas.getContext('2d');

    video.addEventListener('resize', function(e) {
        console.log('video resized');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    });
    
    var lastDimmed = 0,
        msPerDim = 25;

    video.addEventListener('playing', blendWithLast, false);
    function blendWithLast() {

        var now = performance.now();

        if (lastDimmed == 0) {
            lastDimmed = now;  // Initialisation
        }
        var ptsToDim = Math.floor((now - lastDimmed) / msPerDim);

        if (ptsToDim > 3) {
            ptsToDim = Math.min(ptsToDim, 255);
            // dim old pixels slightly by overlaying slightly-transparent layer 
            ctx.fillStyle = 'RGBA(0,0,0,' + ptsToDim/255 + ')';
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            lastDimmed += ptsToDim * msPerDim;
        }

        // pix = max(new_pix, old_pix (maybe dimmed))
        ctx.globalCompositeOperation = 'lighten'

        // Get a new frame
        ctx.drawImage(video, 0, 0);

        requestAnimationFrame(blendWithLast);
    }

    takePhotoButton.addEventListener('click', takePhoto);
    function takePhoto() {
        ctx.globalCompositeOperation = 'source-over'
        var dWidth = Math.max(canvas.width, canvas.height) * 0.17,
            dHeight = dWidth / logoWatermark.width * logoWatermark.height,
            dx = canvas.width * 0.98 - dWidth,
            dy = canvas.height * 0.98 - dHeight;
        ctx.drawImage(logoWatermark, dx, dy, dWidth, dHeight);
        download('cyclotron.png', canvas.toDataURL('image/png'));
    }
    takePhotoButton.addEventListener('mousedown', function(){
        takePhotoButton.firstElementChild.src = "img/shutter-pressed.png";
    });
    takePhotoButton.addEventListener('touchstart', function(){
        takePhotoButton.firstElementChild.src = "img/shutter-pressed.png";
    });
    window.addEventListener('mouseup', function(){
        takePhotoButton.firstElementChild.src = "img/shutter-button.png";
    });
    window.addEventListener('touchend', function(){
        takePhotoButton.firstElementChild.src = "img/shutter-button.png";
    });

    // recordVideoButton.addEventListener('click', recordVideo);
    // function recordVideo() {
    //     var options = {
    //        type: 'canvas'
    //     };
    //     var recordRTC = RecordRTC(canvas, options);
    //     recordRTC.setRecordingDuration(
    //         5 * 1000, gifURL => recordRTC.save('bla.webm')
    //     );
    //     recordRTC.startRecording();
    // }

    function download(filename, dataURL) {
        var link = document.createElement('a');
        link.download = filename;
        link.href = dataURL;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function getSourcesForChrome() {
        navigator.mediaDevices.enumerateDevices()
            .then(gotDevicesForChrome)
            .catch(err => console.error(err));
    }

    function gotDevicesForChrome(deviceInfos) {
        console.log(deviceInfos);
        chromeVideoDeviceInfos = deviceInfos.filter(
            (el, i, arr) => (el.kind === 'videoinput') 
        );
        if (chromeVideoDeviceInfos.length > 1) {
            showCameraToggleButtonForChrome();
        }
        var constraints = {audio: false, video: { deviceId: chromeVideoDeviceInfos[chromeVideoDeviceIndex].deviceId }};
        attachStream(constraints);
    }

    function changeDeviceForChrome() {
        chromeVideoDeviceIndex = (chromeVideoDeviceIndex + 1) % chromeVideoDeviceInfos.length;
        var constraints = {audio: false, video: { deviceId: chromeVideoDeviceInfos[chromeVideoDeviceIndex].deviceId }};
        attachStream(constraints);
    }

    function showCameraToggleButtonForChrome() {
        var button = document.getElementById('cameraToggleForChrome');
        cameraToggleForChrome.style.display = 'inline';
        // recordVideoButton.style.display = 'inline';
        cameraToggleForChrome.addEventListener('click', function(ev){
            changeDeviceForChrome();
            ev.preventDefault();
        }, false);
    }
</script>
<div id="invisible-assets" style="display:none;">
    <img id="logoWatermark" src="img/logo.svg">
    <img id="pressedShutterButton" src="img/shutter-pressed.png">
</div>
</body>
</html>